# schema/skills/troubleshooting.yaml
# SQL 问题排查和故障排除指南
# 这个文档提供常见 SQL 问题和解决方案
common_issues:
  - error: "relation \"xxx\" does not exist"
    description: "表名或列名不存在"
    possible_causes:
      - cause: "表名拼写错误"
        solution: "使用 /sql-zen-explore 检查正确的表名"
      - cause: "列名拼写错误"
        solution: "读取表定义 YAML，确认列名"
      - cause: "表不在当前数据库中"
        solution: "检查 schema/tables/ 中列出的所有表"
    prevention:
      - "使用 /sql-zen-explore 系统化地探索 Schema"
      - "使用 cat 读取表定义，复制粘贴表名和列名"
  - error: "column \"xxx\" does not exist"
    description: "列名不存在"
    possible_causes:
      - cause: "列名拼写错误"
        solution: "读取表定义 YAML，确认列名"
      - cause: "列在不同表中"
        solution: "检查是否需要 JOIN 到正确的表"
      - cause: "使用了别名但未定义"
        solution: "检查 FROM 或 JOIN 子句中的表别名"
    prevention:
      - "仔细阅读 schema/tables/<table>.yaml 中的 columns 定义"
      - "使用表别名时，确保别名已定义"
  - error: "operator does not exist"
    description: "使用了不存在的操作符"
    possible_causes:
      - cause: "数据类型不匹配"
        solution: "检查列的数据类型，可能需要类型转换（::text, ::int 等）"
      - cause: "数据库不支持该操作符"
        solution: "使用数据库特定的语法"
    prevention:
      - "在 schema/tables/ 中查看列的类型定义"
      - "参考数据库官方文档了解支持的操作符"
  - error: "column must appear in the GROUP BY clause or be used in an aggregate function"
    description: "SELECT 中的列不在 GROUP BY 中"
    possible_causes:
      - cause: "忘记将非聚合列添加到 GROUP BY"
        solution: "将该列添加到 GROUP BY 子句"
      - cause: "需要对该列使用聚合函数"
        solution: "使用 MAX(), MIN(), SUM(), COUNT() 等聚合函数"
    examples:
      - correct: "SELECT user_id, COUNT(*) FROM orders GROUP BY user_id"
      - wrong: "SELECT user_name, COUNT(*) FROM orders GROUP BY user_id"
    prevention:
      - "规则：SELECT 中的每个非聚合列都必须在 GROUP BY 中"
      - "参考 schema/skills/best-practices.yaml 中的 GROUP BY 示例"
performance_issues:
  - issue: "查询执行时间过长"
    symptoms:
      - "查询超时（超过 30 秒）"
      - "返回结果很慢"
    causes:
      - cause: "全表扫描"
        solution: "添加 WHERE 条件使用索引，使用 EXPLAIN 分析"
      - cause: "大结果集"
        solution: "使用 LIMIT 限制返回行数，考虑分页"
    optimization_steps:
      - "1. 使用 EXPLAIN ANALYZE 查看查询计划"
      - "2. 检查是否使用了索引列"
      - "3. 考虑添加 LIMIT"
      - "4. 简化复杂的子查询"
quick_reference:
  problem: "找不到表"
    quick_fix: "使用 ls schema/tables/ 查看所有表"
    skill: "/sql-zen-explore"
  problem: "JOIN 结果不对"
    quick_fix: "检查 schema/joins/ 中的关联定义"
    check: "确认 ON 条件正确"
  problem: "时间查询错误"
    quick_fix: "参考 schema/skills/common-queries.yaml 的时间范围模式"
    example: "使用 >= 和 < 而不是 DATE() 函数"
  problem: "聚合查询错误"
    quick_fix: "检查 GROUP BY 是否包含所有非聚合列"
    reference: "schema/skills/best-practices.yaml 的 GROUP BY 部分"
  problem: "枚举值使用错误"
    quick_fix: "从 schema/tables/ 复制 enum.value"
    check: "不要使用 enum.description 或手动输入的值"
using_skills:
  skill: "sql-zen-query"
    usage: "使用 /sql-zen-query skill 处理错误时，skill 会自动参考本文件中的解决方案"
    benefit: "系统化的故障排除流程，减少调试时间"
  skill: "sql-zen-explore"
    usage: "使用 /sql-zen-explore 重新探索 Schema，确保表名和列名正确"
    benefit: "避免拼写错误，使用实际的表定义"
support:
  documentation: "查看 schema/README.md 获取更多 Schema 信息"
  examples: "参考 schema/examples/ 中的示例查询"
  community: "报告问题到 SQL-Zen GitHub 仓库"
  note: |
    本文档应该随着使用不断更新。
