# 阐数 (ChanBI) 产品需求文档 (PRD)

**版本**: v0.1.0 - 初始版本
**创建日期**: 2026-01-26
**状态**: 草稿

---

## 1. 产品概述

### 1.1 产品定位

**阐数 (ChanBI)** 是一个基于 AI 的开源商业智能 (BI) 平台，让非技术用户也能通过自然语言轻松查询、分析和洞察数据。

**核心价值主张**:
- 🎯 **零代码查询** - 用自然语言提问，自动生成 SQL
- 🧠 **智能语义层** - 通过 Cube 层定义业务指标，隐藏数据复杂性
- 📊 **丰富可视化** - 自动选择最佳图表类型展示数据
- 🔄 **对话式分析** - 支持多轮对话，深入探索数据

### 1.2 目标用户

**主要用户**:
1. **业务分析师** - 快速生成报表，节省写 SQL 的时间
2. **产品经理** - 自主查询数据，不依赖数据工程师
3. **运营人员** - 日常数据监控和快速分析
4. **小团队** - 无需专业 BI 工具也能做数据分析

**次要用户**:
1. **数据工程师** - 通过可视化界面管理 Schema 和 Cube 层
2. **管理层** - 查看仪表盘和关键指标

### 1.3 核心场景

**场景 1: 快速查询**
> "我想看上个月各城市的销售额"
> 系统自动生成 SQL，执行查询，展示柱状图

**场景 2: 深入分析**
> 用户: "哪些产品的利润率最高？"
> 系统: 展示前 10 个产品的利润率
> 用户: "再看一下最近 7 天的趋势"
> 系统: 更新为折线图，展示时间趋势

**场景 3: 仪表盘构建**
> 用户将常用查询保存为"销售仪表盘"，包含多个指标和图表

**场景 4: 数据洞察**
> 系统自动分析数据，提供洞察："本月的转化率比上月提升了 15%，主要来自北京地区"

---

## 2. 功能需求

### 2.1 核心功能 (MVP)

#### 2.1.1 用户认证

**需求描述**: 支持用户注册、登录、登出

**功能点**:
- [ ] 邮箱注册
- [ ] 密码登录
- [ ] 密码重置
- [ ] 会话管理
- [ ] 用户个人资料

**优先级**: P0
**技术方案**:
- JWT 认证
- bcrypt 密码加密
- NextAuth.js 或自研认证系统

---

#### 2.1.2 数据源管理

**需求描述**: 用户可以连接和管理多个数据源

**功能点**:
- [ ] 添加数据源（MySQL, PostgreSQL, SQLite）
- [ ] 测试连接
- [ ] 编辑数据源配置
- [ ] 删除数据源
- [ ] 数据源权限控制（团队版）

**优先级**: P0
**技术方案**:
- 连接池管理
- 连接信息加密存储
- 延迟初始化连接

---

#### 2.1.3 语义层管理 (Schema & Cube)

**需求描述**: 可视化编辑 Schema 层和 Cube 层定义

**Schema 层编辑器**:
- [ ] 表列表展示
- [ ] 创建/编辑/删除表
- [ ] 添加/编辑/删除列
- [ ] 设置主键、外键
- [ ] 添加表描述和列描述

**Cube 层编辑器**:
- [ ] Cube 列表展示
- [ ] 创建/编辑/删除 Cube
- [ ] 可视化添加维度（维度、粒度）
- [ ] 可视化添加指标（名称、SQL、类型）
- [ ] 可视化添加过滤器
- [ ] YAML 实时预览
- [ ] 语法校验

**优先级**: P0
**技术方案**:
- Monaco Editor (代码编辑)
- 拖拽式界面 (未来版本)
- Schema Parser 验证

---

#### 2.1.4 智能查询 (Chat)

**需求描述**: 用户通过自然语言提问，系统自动生成 SQL 并执行

**功能点**:
- [ ] 聊天界面
- [ ] 流式响应（Streaming）
- [ ] 支持 Markdown 格式输出
- [ ] 显示执行 SQL（可折叠）
- [ ] 显示执行时间
- [ ] 支持多轮对话
- [ ] 对话历史记录
- [ ] 示例问题引导

**优先级**: P0
**技术方案**:
- 复用 SQL-Zen Agent
- WebSocket 流式传输
- React Query 缓存

---

#### 2.1.5 查询结果展示

**需求描述**: 展示查询结果，支持表格和多种图表

**功能点**:
- [ ] 表格展示（支持分页、排序、过滤）
- [ ] 自动选择图表类型
- [ ] 支持图表类型切换（柱状图、折线图、饼图、表格）
- [ ] 图表交互（Tooltip、缩放）
- [ ] 导出数据（CSV, Excel）
- [ ] 查询结果缓存（避免重复查询）

**优先级**: P0
**技术方案**:
- Recharts 图表库
- react-table 表格
- 客户端分页、排序

---

#### 2.1.6 查询历史与收藏

**需求描述**: 管理查询历史，收藏常用查询

**功能点**:
- [ ] 查询历史列表
- [ ] 搜索历史记录
- [ ] 收藏/取消收藏查询
- [ ] 收藏夹分类管理
- [ ] 一键重新执行历史查询
- [ ] 给查询添加备注

**优先级**: P1
**技术方案**:
- PostgreSQL 存储历史
- ElasticSearch 搜索（可选）

---

#### 2.1.7 仪表盘 (Dashboard)

**需求描述**: 创建和管理仪表盘，展示多个指标和图表

**功能点**:
- [ ] 创建/编辑/删除仪表盘
- [ ] 添加组件（图表、指标卡片、文本）
- [ ] 拖拽布局
- [ ] 组件大小调整
- [ ] 全屏展示
- [ ] 刷新按钮（手动/自动）
- [ ] 仪表盘分享链接（团队版）

**优先级**: P1
**技术方案**:
- react-grid-layout
- 本地存储布局配置

---

### 2.2 增强功能 (v0.5.0)

#### 2.2.1 数据洞察

**需求描述**: 系统自动分析数据，生成洞察和建议

**功能点**:
- [ ] 自动检测异常值
- [ ] 趋势分析（上升/下降）
- [ ] 同比/环比分析
- [ ] 关键影响因素分析
- [ ] 洞察文本生成
- [ ] 洞察收藏和评论

**优先级**: P2
**技术方案**:
- 统计算法（Z-score, 移动平均）
- LLM 生成洞察文本

---

#### 2.2.2 报告订阅

**需求描述**: 定期生成报告，通过邮件发送

**功能点**:
- [ ] 创建订阅计划
- [ ] 设置频率（日报、周报、月报）
- [ ] 选择仪表盘或查询
- [ ] 自定义报告模板
- [ ] 邮件发送
- [ ] 订阅历史查看

**优先级**: P2
**技术方案**:
- Bull Queue 任务调度
- Email 模板（MJML）
- PDF 生成（Puppeteer）

---

#### 2.2.3 团队协作

**需求描述**: 支持多人协作，共享资源和权限管理

**功能点**:
- [ ] 团队创建和管理
- [ ] 成员邀请
- [ ] 角色权限（管理员、编辑者、查看者）
- [ ] 资源共享（仪表盘、查询、Cube）
- [ ] 操作审计日志
- [ ] 单点登录（SSO）

**优先级**: P2
**技术方案**:
- RBAC 权限模型
- PostgreSQL 行级安全

---

#### 2.2.4 API & Webhooks

**需求描述**: 提供 REST API 和 Webhook，支持自动化

**功能点**:
- [ ] REST API 文档
- [ ] API Key 管理
- [ ] 查询 API
- [ ] Webhook 事件（查询执行、异常）
- [ ] Webhook 重试机制
- [ ] 速率限制

**优先级**: P2
**技术方案**:
- OpenAPI 规范
- Redis 队列处理 Webhook

---

## 3. 非功能需求

### 3.1 性能

| 指标 | 目标 | 说明 |
|------|------|------|
| 首屏加载时间 | < 2s | Lighthouse Performance > 90 |
| API 响应时间 | P95 < 500ms | 不包括 LLM 调用 |
| 查询执行时间 | < 5s | 简单查询（< 1000 行）|
| 并发用户数 | 100+ | 单实例支持 |

### 3.2 可用性

| 指标 | 目标 |
|------|------|
| 系统可用性 | 99.5% |
| 故障恢复时间 | < 30 分钟 |
| 数据备份频率 | 每日 |

### 3.3 安全性

| 需求 | 说明 |
|------|------|
| 数据传输 | HTTPS/TLS 1.3 |
| 密码存储 | bcrypt 哈希 |
| SQL 注入防护 | 参数化查询 |
| XSS 防护 | 输入验证和 CSP |
| CSRF 防护 | Token 验证 |

### 3.4 可扩展性

- **水平扩展**: 支持多实例部署
- **数据库支持**: 添加新数据库类型（Oracle, SQL Server）
- **模型支持**: 支持多种 LLM（GPT-4, Claude, Ollama）

### 3.5 可维护性

- 代码覆盖率 > 80%
- 完整的文档
- 代码审查流程
- CI/CD 自动化

---

## 4. 技术架构

### 4.1 技术栈

**前端**:
- 框架: Next.js 14 (App Router)
- UI 库: shadcn/ui (Radix UI)
- 样式: Tailwind CSS
- 状态管理: Zustand
- 数据请求: TanStack Query
- 图表: Recharts
- 编辑器: Monaco Editor
- 表单: Zod + React Hook Form

**后端**:
- 运行时: Node.js 18+
- 框架: Fastify
- ORM: Prisma
- 数据库: PostgreSQL
- 缓存: Redis
- 任务队列: Bull
- 认证: JWT + NextAuth.js

**基础设施**:
- 容器: Docker
- 部署: Vercel (前端) + Railway/Render (后端)
- 监控: Sentry (错误追踪) + Datadog (APM)
- 日志: Pino + Loki

### 4.2 架构图

```
┌─────────────────────────────────────────────┐
│              Frontend (Next.js)             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  Chat UI │  │ Dashboard│  │ Schema   │ │
│  └──────────┘  └──────────┘  └──────────┘ │
└────────────┬──────────────────────────────┘
             │ HTTP/WebSocket
┌────────────▼──────────────────────────────┐
│              Backend (Fastify)            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  REST    │  │WebSocket │  │Agent API │ │
│  └──────────┘  └──────────┘  └──────────┘ │
└────────────┬──────────────────────────────┘
             │
┌────────────▼──────────────────────────────┐
│            Data Layer                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐│
│  │PostgreSQL│  │  Redis   │  │ User's   ││
│  │(Users)   │  │ (Cache)  │  │ Databases││
│  └──────────┘  └──────────┘  └──────────┘│
└───────────────────────────────────────────┘
```

---

## 5. 路线图

### Phase 1: MVP (4-6周) - v0.1.0

**目标**: 可用的核心功能

**功能**:
- ✅ 用户认证
- ✅ 数据源管理
- ✅ 语义层编辑器
- ✅ 智能查询（Chat）
- ✅ 查询结果展示
- ✅ 基础图表（3种）

**里程碑**:
- Week 1-2: 搭建框架 + 用户认证
- Week 3-4: 数据源管理 + 语义层编辑器
- Week 5-6: Chat + 结果展示 + 图表

### Phase 2: 增强 (4-6周) - v0.2.0

**目标**: 提升用户体验

**功能**:
- ✅ 查询历史与收藏
- ✅ 仪表盘（基础）
- ✅ 更多图表类型（5+）
- ✅ 导出功能
- ✅ 性能优化

### Phase 3: 高级 (6-8周) - v0.3.0

**目标**: 企业级功能

**功能**:
- ✅ 数据洞察
- ✅ 报告订阅
- ✅ 团队协作（基础）
- ✅ API 文档
- ✅ 单元测试和集成测试

### Phase 4: 完善 (持续迭代) - v1.0.0

**目标**: 完整的企业级 BI 平台

**功能**:
- ✅ 高级仪表盘
- ✅ 完整的团队协作
- ✅ Webhooks
- ✅ 多语言支持
- ✅ 私有化部署方案

---

## 6. 成功指标

### 6.1 产品指标

| 指标 | 目标 | 时间 |
|------|------|------|
| 注册用户数 | 100+ | MVP 发布后 1 个月 |
| 活跃用户数 (MAU) | 50+ | MVP 发布后 1 个月 |
| 查询成功率 | > 90% | 持续 |
| 用户满意度 (NPS) | > 40 | MVP 发布后 3 个月 |

### 6.2 技术指标

| 指标 | 目标 |
|------|------|
| 代码覆盖率 | > 80% |
| Lighthouse Performance | > 90 |
| API 响应时间 P95 | < 500ms |
| 系统可用性 | > 99.5% |

---

## 7. 竞品分析

### 7.1 直接竞品

| 产品 | 优势 | 劣势 | 我们的差异化 |
|------|------|------|------------|
| [Metabase](https://www.metabase.com/) | 成熟、开源 | 需要写 SQL | 自然语言查询 |
| [Dataherald](https://dataherald.com/) | AI 驱动 | 闭源、付费 | 开源、免费 |
| [Athena Intelligence](https://www.athena.ai/) | 强大的 AI | 昂贵 | 开源、可自部署 |
| [Rilla AI](https://www.rilla.ai/) | 美观的 UI | 功能有限 | 双层语义架构 |

### 7.2 竞争优势

1. **开源免费** - 与 Dataherald, Athena 不同
2. **双层语义架构** - 独特的 Cube 层设计
3. **自然语言优先** - 比 Metabase 更易用
4. **自部署友好** - 无 Vendor Lock-in
5. **可扩展性强** - 支持多种 LLM 和数据库

---

## 8. 风险与应对

### 8.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| LLM 生成 SQL 不准确 | 高 | 中 | Cube 层约束、人工审核机制 |
| 性能问题（大表查询） | 中 | 中 | 查询限制、异步执行、缓存 |
| 数据安全（连接信息泄露）| 高 | 低 | 加密存储、权限控制 |

### 8.2 市场风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 用户学习成本高 | 中 | 中 | 示例引导、教程文档 |
| 竞品快速迭代 | 高 | 高 | 快速开发、社区驱动 |

### 8.3 运营风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 服务器成本过高 | 中 | 中 | 按需扩容、成本监控 |
| 维护成本过高 | 中 | 低 | 自动化运维、社区贡献 |

---

## 9. 附录

### 9.1 相关文档

- [SQL-Zen README](../README.md)
- [SQL-Zen 配置指南](../docs/configuration.md)
- [SQL-Zen 设计文档](../docs/design.md)

### 9.2 参考资料

- [Metabase Architecture](https://www.metabase.com/learn/architecture/)
- [Semantic Layer Design](https://cube.dev/docs/semantic-layer/introduction)
- [Next.js App Router](https://nextjs.org/docs/app)

### 9.3 变更记录

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| v0.1.0 | 2026-01-26 | slicenfer | 初始版本 |

---

**文档状态**: ✅ 草稿完成
**下一步**: 团队评审、细化 MVP 范围
